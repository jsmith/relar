rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /user_data/{userId} {
      function isUser() {
      	return userId == request.auth.uid
      }
      
      function affectedKeys() {
        return request.resource.data.diff(resource.data).affectedKeys();
      }

    	match /{data=**} {
        // restricted this so that users can't just write willy nilly
      	allow read: if isUser()
      }
      
      match /songs/{songId} {
				function validUpdate() {
          // artwork is slightly insecure since we really only want to allow updates to "artwork.artworkDownloadUrl32"
          return affectedKeys().hasOnly(['lastPlayed', 'played', 'liked', 'downloadUrl', 'artwork'])
        }
        
      	allow update: if isUser() && validUpdate()
      }
    }
  }
}
